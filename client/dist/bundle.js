!function(e){var t={};function a(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=e,a.c=t,a.d=function(e,t,o){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(a.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(o,n,function(t){return e[t]}.bind(null,n));return o},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=0)}([function(e,t,a){"use strict";a.r(t);class o{constructor(e,t,a){Object.assign(this,{_quantidade:t,_valor:a}),this._data=new Date(e.getTime()),Object.freeze(this)}get volume(){return this._quantidade*this._valor}get data(){return new Date(this._data.getTime())}get quantidade(){return this._quantidade}get valor(){return this._valor}equals(e){return JSON.stringify(this)==JSON.stringify(e)}}class n{constructor(e){this._connection=e,this._store="negociacoes"}adiciona(e){return new Promise((t,a)=>{const o=this._connection.transaction([this._store],"readwrite").objectStore(this._store).add(e);o.onsuccess=e=>t(),o.onerror=e=>{console.log(e.target.error),a("Não foi possível salvar a negociação")}})}listaTodos(){return new Promise((e,t)=>{const a=[],n=this._connection.transaction([this._store],"readwrite").objectStore(this._store).openCursor();n.onsuccess=t=>{const n=t.target.result;if(n){const e=new o(n.value._data,n.value._quantidade,n.value._valor);a.push(e),n.continue()}else e(a)},n.onerror=e=>{console.log(e.target.error),t("Não foi possível listar as negociações")}})}apagaTodas(){return new Promise((e,t)=>{const a=this._connection.transaction([this._store],"readwrite").objectStore(this._store).clear();a.onsuccess=t=>e(),a.onerror=e=>{console.log("Não foi possível apagar as negociações")}})}}class r{get(e){return new Promise((t,a)=>{const o=new XMLHttpRequest;o.open("GET",e),o.onreadystatechange=()=>{4==o.readyState&&(200==o.status?t(JSON.parse(o.responseText)):(console.log(o.responseText),a(o.responseText)))},o.send()})}}class s extends Error{constructor(e=""){super(e),this.name=this.constructor.name}}const i=s;function c(e){return function(e){return e instanceof i||Object.getPrototypeOf(e)instanceof i}(e)?e.message:(console.log(e),"Não foi possível realizar a operação.")}class u{constructor(){this._http=new r}obterNegociacoesDaSemana(){return this._http.get("negociacoes/semana").then(e=>e.map(e=>new o(new Date(e.data),e.quantidade,e.valor)),e=>{throw new s("Não foi possível obter as negociações da semana")})}obterNegociacoesDaSemanaAnterior(){return this._http.get("negociacoes/anterior").then(e=>e.map(e=>new o(new Date(e.data),e.quantidade,e.valor)),e=>{throw new s("Não foi possível obter as negociações da semana anterior")})}obterNegociacoesDaSemanaRetrasada(){return this._http.get("negociacoes/retrasada").then(e=>e.map(e=>new o(new Date(e.data),e.quantidade,e.valor)),e=>{throw new s("Não foi possível obter as negociações da semana retrasada")})}async obterNegociacoesDoPeriodo(){try{return(await Promise.all([this.obterNegociacoesDaSemana(),this.obterNegociacoesDaSemanaAnterior(),this.obterNegociacoesDaSemanaRetrasada()])).reduce((e,t)=>e.concat(t),[]).sort((e,t)=>t.data.getTime()-e.data.getTime())}catch(e){throw console.log(e),new s("Não foi possível obter as negociações do período")}}}class l{constructor(){this._negociacoes=[],Object.freeze(this)}adiciona(e){this._negociacoes.push(e)}paraArray(){return[].concat(this._negociacoes)}get volumeTotal(){return this._negociacoes.reduce((e,t)=>e+t.volume,0)}esvazia(){this._negociacoes.length=0}}class d{constructor(e){this._elemento=document.querySelector(e)}template(e){throw new Error("Você precisa implementar o método template")}update(e){this._elemento.innerHTML=this.template(e)}}class h extends d{template(e){return e.texto?`<p class="alert alert-info">${e.texto}</p>`:"<p></p>"}}class p extends s{constructor(){super("A data deve estar no formato dd/mm/aaaa"),this.name=this.constructor.name}}class g{constructor(){throw new Error("Esta classe não pode ser instanciada!")}static paraTexto(e){return`${e.getDate()}/${e.getMonth()+1}/${e.getFullYear()}`}static paraData(e){if(!/\d{2}\/\d{2}\/\d{4}$/.test(e))throw new p;return new Date(...e.split("/").reverse().map((e,t)=>e-t%2))}}class m extends d{template(e){return`\n        <table class="table table-hover table-bordered">\n        <thead>\n            <tr>\n                <th>DATA</th>\n                <th>QUANTIDADE</th>\n                <th>VALOR</th>\n                <th>VOLUME</th>\n            </tr>\n        </thead>\n            ${e.paraArray().map(e=>`    <tr>\n                        <td>${g.paraTexto(e.data)}</td>\n                        <td>${e.quantidade}</td>\n                        <td>${e.valor}</td>\n                        <td>${e.volume}</td>\n                    </tr>\n                `).join("")}\n        <tbody>\n        </tbody>\n        \n        <tfoot>\n            <tr>\n                <td colspan="3"></td>\n                <td>${e.volumeTotal}</td>\n            </tr>\n        </tfoot>\n    </table> `}}class _{constructor(e=""){this._texto=e}get texto(){return this._texto}set texto(e){this._texto=e}}class f{static create(e,t,a){return new Proxy(e,{get:(e,o,n)=>f._ehFuncao(e[o])&&t.includes(o)?function(){console.log(`"${o}" disparou a armadilha`),e[o].apply(e,arguments),a(e)}:e[o],set(e,o,n,r){const s=Reflect.set(e,o,n);return t.includes(o)&&a(e),s}})}static _ehFuncao(e){return typeof e==typeof Function}}class w{constructor(e,t,...a){const o=f.create(e,a,e=>{t.update(e)});return t.update(e),o}}const v=["negociacoes"];let b=null,y=null;class x{constructor(){throw new Error("Não é possível criar instância dessa classe")}static getConnection(){return new Promise((e,t)=>{if(b)return e(b);const a=indexedDB.open("jscangaceiro",2);a.onupgradeneeded=e=>{x._createStores(e.target.result)},a.onsuccess=t=>{b=t.target.result,y=b.close.bind(b),b.close=()=>{throw new Error("Você não pode fechar diretamente a conexão")},e(b)},a.onerror=e=>{console.log(e.target.result),t(e.target.error.name)}})}static _createStores(e){v.forEach(t=>{e.objectStoreNames.contains(t)&&e.deleteObjectStore(t),e.createObjectStore(t,{autoIncrement:!0})})}static closeCommection(){b&&y()}}async function N(){let e=await x.getConnection();return new n(e)}const D=new class{constructor(){const e=document.querySelector.bind(document);this._inputData=e("#data"),this._inputQuantidade=e("#quantidade"),this._inputValor=e("#valor"),this._negociacoes=new w(new l,new m("#negociacoes"),"adiciona","esvazia"),this._mensagem=new w(new _,new h("#mensagemView"),"texto"),this._service=new u,this._init()}async _init(){try{const e=await N();(await e.listaTodos()).forEach(e=>this._negociacoes.adiciona(e))}catch(e){this._mensagem.texto=c(e)}}async adiciona(e){try{e.preventDefault();const t=this._criaNegociacao(),a=await N();await a.adiciona(t),this._negociacoes.adiciona(t),this._mensagem.texto="Negociação adicionada com sucesso",this._limpaFormulorio()}catch(e){this._mensagem.texto=c(e)}}async apaga(){try{const e=await N();await e.apagaTodas(),this._negociacoes.esvazia(),this._mensagem.texto="Negociações apacada com sucesso"}catch(e){this._mensagem.texto=c(e)}}_criaNegociacao(){return new o(g.paraData(this._inputData.value),parseInt(this._inputQuantidade.value),parseFloat(this._inputValor.value))}_limpaFormulorio(){this._inputData.value="",this._inputQuantidade.value=1,this._inputValor.value=0,this._inputData.focus()}async importaNegociacoes(){try{const e=await this._service.obterNegociacoesDoPeriodo();console.log(e),e.filter(e=>!this._negociacoes.paraArray().some(t=>e.equals(t))).forEach(e=>this._negociacoes.adiciona(e)),this._mensagem.texto="Negociações do período importadas com sucesso"}catch(e){this._mensagem.texto=c(e)}}},S=document.querySelector.bind(document);S(".form").addEventListener("submit",D.adiciona.bind(D)),S("#botao-apaga").addEventListener("click",D.apaga.bind(D)),S("#botao-importa").addEventListener("click",function(e,t){let a=0;return()=>{clearTimeout(a),a=setTimeout(()=>e(),t)}}(()=>{console.log("EXECUTOU A OPERAÇÃO DO DEBOUNCE")},1e3))}]);